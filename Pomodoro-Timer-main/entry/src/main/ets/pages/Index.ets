import { promptAction, router } from '@kit.ArkUI';
import dataPreferences from '@ohos.data.preferences';
import { TimerCard } from '../components/TimerCard';
import { TaskItem } from '../components/TaskItem';
import { HttpService } from '../common/HttpService';

interface Task {
  id: number;
  title: string;
  completed: boolean;
  pomodoros: number;
  todayPomodoros: number;
  lastPomodoroDate: string;
}

// æ·»åŠ ä¸»é¢˜é¢œè‰²æŽ¥å£
interface ThemeColors {
  primary: string;
  secondary: string;
  background: string;
  cardBg: string;
  textPrimary: string;
  textSecondary: string;
}

@Entry
@Component
struct Index {
  @State remainingTime: number = 25 * 60;
  @State isRunning: boolean = false;
  @State isWorkTime: boolean = true;
  @State tasks: Task[] = [];
  @State newTask: string = '';
  @State currentTaskId: number = -1;
  @State totalPomodoros: number = 0;
  @State todayPomodoros: number = 0;
  @State showAddTask: boolean = false;
  @State todayDate: string = new Date().toDateString();
  @State refreshFlag: number = 0;
  private timer: number = 0;
  private preferences: dataPreferences.Preferences | null = null;
  // æ·»åŠ  dialogController
  dialogController: CustomDialogController = new CustomDialogController({
    builder: this.DialogBuilder,
    alignment: DialogAlignment.Center,
    offset: { dx: 0, dy: -20 },
    customStyle: true,
    autoCancel: true,
    cancel: () => {
      this.showAddTask = false;
    }
  });
  // æ·»åŠ åˆ é™¤å¯¹è¯æ¡†æŽ§åˆ¶å™¨
  deleteDialogController: CustomDialogController = new CustomDialogController({
    builder: this.DeleteDialogBuilder,
    alignment: DialogAlignment.Center,
    offset: { dx: 0, dy: -20 },
    customStyle: true,
    autoCancel: true
  });
  // å½“å‰è¦åˆ é™¤çš„ä»»åŠ¡ID
  @State taskToDelete: Task | null = null;

  // å®šä¹‰å¯¹è¯æ¡†å†…å®¹æž„å»ºå™¨
  @Builder
  DialogBuilder() {
    Column() {
      Text('æ·»åŠ ä»»åŠ¡')
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .margin({ top: 16, bottom: 16 })

      TextInput({ placeholder: 'è¾“å…¥ä»»åŠ¡åç§°' })
        .width('90%')
        .height(50)
        .margin({ top: 8 })
        .onChange((value: string) => {
          this.newTask = value;
        })

      Row() {
        Button('å–æ¶ˆ')
          .width('40%')
          .height(40)
          .backgroundColor(this.themeColors.textSecondary)
          .margin({ top: 20, right: 8 })
          .onClick(() => {
            this.dialogController.close();
            this.showAddTask = false;
          })

        Button('æ·»åŠ ')
          .width('40%')
          .height(40)
          .backgroundColor(this.themeColors.primary)
          .margin({ top: 20, left: 8 })
          .onClick(() => {
            if (this.newTask.trim()) {
              // æ£€æŸ¥ä»»åŠ¡åç§°æ˜¯å¦é‡å¤
              if (this.isTaskNameDuplicate(this.newTask.trim())) {
                promptAction.showToast({
                  message: 'ä»»åŠ¡åç§°å·²å­˜åœ¨',
                  duration: 2000,
                });
                return;
              }
              this.createTask(this.newTask);
              this.newTask = '';
              this.dialogController.close();
              this.showAddTask = false;
            }
          })
      }
      .width('90%')
      .justifyContent(FlexAlign.SpaceAround)
    }
    .width('90%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(24)
  }

  // å®šä¹‰åˆ é™¤ç¡®è®¤å¯¹è¯æ¡†å†…å®¹
  @Builder
  DeleteDialogBuilder() {
    Column() {
      Text('ç¡®è®¤åˆ é™¤')
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .margin({ top: 16, bottom: 16 })

      Text(this.taskToDelete ? `æ˜¯å¦åˆ é™¤ä»»åŠ¡"${this.taskToDelete.title}"ï¼Ÿ` : '')
        .fontSize(16)
        .fontColor(this.themeColors.textSecondary)
        .margin({ bottom: 20 })
        .textAlign(TextAlign.Center)

      Row() {
        Button('å–æ¶ˆ')
          .width('40%')
          .height(40)
          .backgroundColor(this.themeColors.textSecondary)
          .margin({ top: 20, right: 8 })
          .onClick(() => {
            this.deleteDialogController.close();
            this.taskToDelete = null;
          })

        Button('åˆ é™¤')
          .width('40%')
          .height(40)
          .backgroundColor(this.themeColors.primary)
          .margin({ top: 20, left: 8 })
          .onClick(() => {
            if (this.taskToDelete) {
              this.deleteTask(this.taskToDelete);
            }
            this.deleteDialogController.close();
            this.taskToDelete = null;
          })
      }
      .width('90%')
      .justifyContent(FlexAlign.SpaceAround)
    }
    .width('90%')
    .padding(16)
    .backgroundColor(Color.White)
    .borderRadius(24)
  }

  // æ·»åŠ æ£€æŸ¥ä»»åŠ¡åç§°æ˜¯å¦é‡å¤çš„æ–¹æ³•
  private isTaskNameDuplicate(taskName: string): boolean {
    return this.tasks.some(task => task.title.toLowerCase() === taskName.toLowerCase());
  }

  async aboutToAppear() {
    try {
      // èŽ·å–preferenceså®žä¾‹
      const context = getContext(this);
      this.preferences = await dataPreferences.getPreferences(context, 'PomodoroData');

      // åŠ è½½ä¿å­˜çš„æ•°æ®
      const tasksStr = await this.preferences.get('tasks', '[]');
      this.tasks = JSON.parse(tasksStr as string);
      this.totalPomodoros = await this.preferences.get('totalPomodoros', 0) as number;

      // åˆå§‹åŒ–ä»Šæ—¥æ€»ç•ªèŒ„æ•°
      this.updateTodayTotal();
    } catch (error) {
      console.error('Failed to load data:', error);
    }
  }

  // æ·»åŠ ä¿å­˜æ•°æ®çš„æ–¹æ³•
  private async saveData() {
    if (this.preferences) {
      try {
        await this.preferences.put('tasks', JSON.stringify(this.tasks));
        await this.preferences.put('totalPomodoros', this.totalPomodoros);
        await this.preferences.flush();
      } catch (error) {
        console.error('Failed to save data:', error);
      }
    }
  }

  // ä¿®æ”¹ä¸»é¢˜é¢œè‰²å®šä¹‰ï¼Œæ·»åŠ ç±»åž‹å£°æ˜Ž
  readonly themeColors: ThemeColors = {
    primary: '#FF6B6B', // ç•ªèŒ„çº¢
    secondary: '#4ECDC4', // æ¸…æ–°é’
    background: '#F7F7F7', // æµ…ç°èƒŒæ™¯
    cardBg: '#FFFFFF', // å¡ç‰‡èƒŒæ™¯
    textPrimary: '#2D3436', // ä¸»è¦æ–‡å­—
    textSecondary: '#636E72'// æ¬¡è¦æ–‡å­—
  }

  @Builder
  TimerSection() {
    TimerCard({
      remainingTime: this.remainingTime,
      isRunning: this.isRunning,
      isWorkTime: this.isWorkTime,
      primaryColor: this.themeColors.primary,
      secondaryColor: this.themeColors.secondary,
      cardBg: this.themeColors.cardBg,
      textSecondary: this.themeColors.textSecondary,
      onStartClick: (): void => {
        this.toggleTimer();
      },
      onResetClick: (): void => {
        this.resetTimer();
      }
    })
  }

  @Builder
  TaskSection() {
    Column() {
      Row() {
        Text('ä»»åŠ¡åˆ—è¡¨')
          .fontSize(20)
          .fontWeight(FontWeight.Medium)
          .fontColor(this.themeColors.textPrimary)

        Blank()

        Button('+')
          .width(50)
          .height(40)
          .fontSize(24)
          .fontWeight(FontWeight.Medium)
          .backgroundColor(this.themeColors.primary)
          .borderRadius(20)
          .onClick(() => {
            this.showAddTask = true;
            this.dialogController.open();
          })
      }
      .width('100%')
      .padding({
        left: 16,
        right: 16,
        top: 16,
        bottom: 8
      })

      List() {
        ForEach(this.tasks, (task: Task) => {
          ListItem() {
            TaskItem({
              task: task,
              isActive: this.currentTaskId === task.id,
              primaryColor: this.themeColors.primary,
              cardBg: this.themeColors.cardBg,
              textPrimary: this.themeColors.textPrimary,
              textSecondary: this.themeColors.textSecondary,
              onTaskClick: (): void => {
                this.selectTask(task.id);
              },
              onDeleteClick: (): void => {
                this.showDeleteConfirm(task);
              }
            })
            .gesture(
              LongPressGesture()
                .onAction(() => {
                  this.showDeleteConfirm(task);
                })
            )
          }
          .margin({ bottom: 5 })
          .swipeAction({ end: this.DeleteButton(task) })
        })
      }
      .width('100%')
      .height('30%')
      .padding({ left: 16, right: 16 })
      .scrollBar(BarState.Auto)

      Row() {
        Text(`ä»Šæ—¥å®Œæˆï¼š${this.todayPomodoros} ðŸ…`)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor(this.themeColors.primary)

        Blank()

        Text(`æ€»è®¡å®Œæˆï¼š${this.totalPomodoros} ðŸ…`)
          .fontSize(20)
          .fontWeight(FontWeight.Medium)
          .fontColor(this.themeColors.textSecondary)
      }
      .width('100%')
      .padding({
        left: 16,
        right: 16,
        top: 12,
        bottom: 12
      })
      .backgroundColor(this.themeColors.cardBg)
      .borderRadius(16)
      .margin({ top: 16 })
    }
  }

  // æ·»åŠ åˆ é™¤æŒ‰é’®æž„å»ºå™¨
  @Builder
  DeleteButton(task: Task) {
    Button() {
      Text('åˆ é™¤')
        .fontSize(16)
        .fontColor(Color.White)
    }
    .width(80)
    .height('100%')
    .backgroundColor(Color.Red)
    .onClick(() => {
      this.showDeleteConfirm(task);
    })
  }

  // ä¿®æ”¹æ˜¾ç¤ºåˆ é™¤ç¡®è®¤æ–¹æ³•
  private showDeleteConfirm(task: Task) {
    this.taskToDelete = task;
    this.deleteDialogController.open();
  }

  // æ·»åŠ åˆ é™¤ä»»åŠ¡æ–¹æ³•
  private async deleteTask(delTask: Task) {
    // å¦‚æžœåˆ é™¤çš„æ˜¯å½“å‰é€‰ä¸­çš„ä»»åŠ¡ï¼Œæ¸…é™¤é€‰ä¸­çŠ¶æ€
    if (delTask.id === this.currentTaskId) {
      this.currentTaskId = -1;
    }

    // åˆ›å»ºæ–°çš„ä»»åŠ¡æ•°ç»„ï¼ŒæŽ’é™¤è¦åˆ é™¤çš„ä»»åŠ¡
    const newTasks: Task[] = [];
    for (const task of this.tasks) {
      if (task.id !== delTask.id) {
        newTasks.push(task);
      }
    }

    // æ›´æ–°ä»»åŠ¡åˆ—è¡¨
    this.tasks = newTasks;

    // æ›´æ–°ä»Šæ—¥æ€»ç•ªèŒ„æ•°
    this.updateTodayTotal();

    // ä¿å­˜æ›´æ”¹
    await this.saveData();

    // æ˜¾ç¤ºåˆ é™¤æˆåŠŸæç¤º
    promptAction.showToast({
      message: 'ä»»åŠ¡ ' + delTask.title + ' å·²åˆ é™¤',
      duration: 2000,
    });
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Text('ç•ªèŒ„æ—¶é’Ÿ')
          .fontSize(22)
          .fontWeight(FontWeight.Bold)
          .fontColor(this.themeColors.textPrimary)
        
        Blank()
        
        // å¯¼èˆªæŒ‰é’®
        Row() {
          Button('ç»Ÿè®¡')
            .width(60)
            .height(36)
            .fontSize(14)
            .backgroundColor(this.themeColors.secondary)
            .borderRadius(18)
            .margin({ right: 8 })
            .onClick(() => {
              router.pushUrl({
                url: 'pages/Statistics'
              });
            })
          
          Button('è®¾ç½®')
            .width(60)
            .height(36)
            .fontSize(14)
            .backgroundColor(this.themeColors.textSecondary)
            .borderRadius(18)
            .onClick(() => {
              router.pushUrl({
                url: 'pages/Settings'
              });
            })
        }
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .backgroundColor(this.themeColors.cardBg)
      .borderRadius(16)
      .margin({ bottom: 16 })
      
      Scroll() {
        Column() {
          this.TimerSection()
          this.TaskSection()
        }
        .width('100%')
      }
      .layoutWeight(1)
      .scrollBar(BarState.Auto)
    }
    .width('100%')
    .height('100%')
    .backgroundColor(this.themeColors.background)
    .padding(16)
  }

  private formatTime(seconds: number): string {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins}:${secs.toString().padStart(2, '0')}`;
  }

  private toggleTimer() {
    if (this.isRunning) {
      clearInterval(this.timer);
    } else {
      this.timer = setInterval(async () => {
        if (this.remainingTime > 0) {
          this.remainingTime--;
        } else {
          await this.completePomodoro();
        }
      }, 1000);
    }
    this.isRunning = !this.isRunning;
  }

  private resetTimer() {
    clearInterval(this.timer);
    this.isRunning = false;
    this.remainingTime = this.isWorkTime ? 25 * 60 : 5 * 60;
  }

  private async completePomodoro() {
    if (this.isWorkTime) {
      this.totalPomodoros++;

      if (this.currentTaskId !== -1) {
        const taskIndex = this.tasks.findIndex(t => t.id === this.currentTaskId);
        if (taskIndex !== -1) {
          // åˆ›å»ºæ–°çš„ä»»åŠ¡æ•°ç»„å¹¶æ›´æ–°ä»»åŠ¡
          const newTasks: Task[] = [];
          for (let i = 0; i < this.tasks.length; i++) {
            if (i === taskIndex) {
              const today = new Date().toDateString();
              newTasks.push({
                id: this.tasks[i].id,
                title: this.tasks[i].title,
                completed: this.tasks[i].completed,
                pomodoros: this.tasks[i].pomodoros + 1,
                todayPomodoros: this.tasks[i].lastPomodoroDate === today ?
                  this.tasks[i].todayPomodoros + 1 : 1,
                lastPomodoroDate: today
              });
            } else {
              newTasks.push(this.tasks[i]);
            }
          }

          // æ›´æ–°ä»»åŠ¡æ•°ç»„
          this.tasks = newTasks;

          // ç«‹å³æ›´æ–°ä»Šæ—¥æ€»ç•ªèŒ„æ•°
          this.updateTodayTotal();
        }
      }

      await this.saveData();

      promptAction.showToast({
        message: 'å¤ªæ£’äº†ï¼å®Œæˆäº†ä¸€ä¸ªðŸ…ï¼',
        duration: 2000,
      });
    }
    this.switchMode();
  }

  // æ›´æ–°ä»Šæ—¥æ€»ç•ªèŒ„æ•°
  private updateTodayTotal() {
    const today = new Date().toDateString();
    let total = 0;
    for (const task of this.tasks) {
      if (task.lastPomodoroDate === today) {
        total += task.todayPomodoros;
      }
    }
    this.todayPomodoros = total;
  }

  private switchMode() {
    this.isWorkTime = !this.isWorkTime;
    this.remainingTime = this.isWorkTime ? 25 * 60 : 5 * 60;
    this.resetTimer();
  }

  private selectTask(id: number) {
    this.currentTaskId = id;
  }

  private async createTask(title: string) {
    const newTask: Task = {
      id: Date.now(),
      title: title,
      completed: false,
      pomodoros: 0,
      todayPomodoros: 0,
      lastPomodoroDate: new Date().toDateString()
    };

    // åˆ›å»ºæ–°æ•°ç»„å¹¶æ·»åŠ ä»»åŠ¡
    const newTasks: Task[] = [];
    for (const task of this.tasks) {
      newTasks.push(task);
    }
    newTasks.push(newTask);

    this.tasks = newTasks;
    await this.saveData();
  }

  aboutToDisappear() {
    clearInterval(this.timer);
    if (this.preferences) {
      this.preferences.flush();
    }
  }
}