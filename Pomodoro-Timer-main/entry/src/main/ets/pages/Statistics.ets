import { router } from '@kit.ArkUI';
import dataPreferences from '@ohos.data.preferences';
import { Task } from '../models/TaskModel';

/**
 * ç»Ÿè®¡æ•°æ®æ¥å£
 */
interface StatisticsData {
  date: string;
  pomodoros: number;
  tasks: number;
  focusTime: number; // åˆ†é’Ÿ
}

interface FocusHistoryRecord {
  seconds: number;
  taskIds: number[];
}

/**
 * ç»Ÿè®¡é¡µé¢ç»„ä»¶
 * å±•ç¤ºç•ªèŒ„é’Ÿä½¿ç”¨æ•°æ®ç»Ÿè®¡ï¼ŒåŒ…æ‹¬å›¾è¡¨å±•ç¤º
 */
@Entry
@Component
struct Statistics {
  @State statisticsData: StatisticsData[] = [];
  @State totalPomodoros: number = 0;
  @State totalFocusSeconds: number = 0;
  @State totalTasks: number = 0;
  @State weekData: StatisticsData[] = [];
  private focusHistory: Record<string, FocusHistoryRecord> = {};
  private preferences: dataPreferences.Preferences | null = null;

  async aboutToAppear(): Promise<void> {
    await this.loadStatisticsData();
  }

  /**
   * åŠ è½½ç»Ÿè®¡æ•°æ®
   */
  private async loadStatisticsData(): Promise<void> {
    try {
      const context = getContext(this);
      this.preferences = await dataPreferences.getPreferences(context, 'PomodoroData');
      
      const tasksStr = await this.preferences.get('tasks', '[]');
      const tasks: Task[] = JSON.parse(tasksStr as string);

      // ä¼˜å…ˆæ ¹æ®ä»»åŠ¡æ•°æ®è®¡ç®—ç»Ÿè®¡ä¿¡æ¯ï¼Œä¿è¯ä¸ä¸»ç•Œé¢ä¿æŒä¸€è‡´
      let totalPomodoros: number = 0;
      tasks.forEach((task: Task) => {
        totalPomodoros += task.pomodoros;
      });

      const focusHistoryStr = await this.preferences.get('focusHistory', '{}');
      this.focusHistory = JSON.parse(focusHistoryStr as string);
      
      // ç”Ÿæˆæœ€è¿‘7å¤©çš„æ•°æ®
      this.generateWeekStatistics();

      this.updateSummaryStats(tasks);
    } catch (error) {
      console.error('Failed to load statistics:', error);
    }
  }

  /**
   * ç”Ÿæˆæœ€è¿‘7å¤©çš„ç»Ÿè®¡æ•°æ®
   */
  private generateWeekStatistics(): void {
    const weekData: StatisticsData[] = [];
    const today = new Date();
    
    for (let i = 6; i >= 0; i--) {
      const date = new Date(today);
      date.setDate(date.getDate() - i);
      const dateStr = date.toDateString();

      const record = this.focusHistory[dateStr];
      const focusMinutes = record ? Math.floor(record.seconds / 60) : 0;
      const dayTasks = record ? record.taskIds.length : 0;
      
      weekData.push({
        date: dateStr,
        pomodoros: focusMinutes,
        tasks: dayTasks,
        focusTime: focusMinutes
      });
    }
    
    this.weekData = weekData;
  }

  /**
   * æ ¼å¼åŒ–æ—¥æœŸæ˜¾ç¤º
   */
  private formatDate(dateStr: string): string {
    const date = new Date(dateStr);
    const month = date.getMonth() + 1;
    const day = date.getDate();
    return `${month}/${day}`;
  }

  /**
   * è·å–æœ€å¤§ç•ªèŒ„æ•°ï¼ˆç”¨äºå›¾è¡¨ç¼©æ”¾ï¼‰
   */
  private getMaxPomodoros(): number {
    if (this.weekData.length === 0) return 1;
    const max = Math.max(...this.weekData.map((d: StatisticsData) => d.pomodoros));
    return max > 0 ? max : 1;
  }

  /**
   * æ ¹æ® focusHistory ä¸ä»»åŠ¡åˆ—è¡¨æ›´æ–°é¡¶éƒ¨ç»Ÿè®¡
   */
  private updateSummaryStats(tasks: Task[]): void {
    let focusSecondsFromHistory = 0;
    const uniqueTaskIds: Set<number> = new Set();

    Object.values(this.focusHistory).forEach((record: FocusHistoryRecord | undefined) => {
      if (!record) {
        return;
      }
      focusSecondsFromHistory += record.seconds || 0;
      record.taskIds.forEach((id: number) => uniqueTaskIds.add(id));
    });

    this.totalFocusSeconds = focusSecondsFromHistory;
    this.totalPomodoros = tasks.reduce((sum: number, task: Task) => sum + task.pomodoros, 0);
    this.totalTasks = tasks.length > 0 ? tasks.length : uniqueTaskIds.size;
  }

  /**
   * æ ¼å¼åŒ–æ€»ä¸“æ³¨æ—¶é—´æ˜¾ç¤º
   */
  private formatFocusTimeDisplay(seconds: number): string {
    if (seconds <= 0) {
      return '0åˆ†é’Ÿ';
    }
    if (seconds < 60) {
      return `${seconds}ç§’`;
    }
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    if (secs === 0) {
      return `${mins}åˆ†é’Ÿ`;
    }
    return `${mins}åˆ†${secs}ç§’`;
  }

  /**
   * æ„å»ºç»Ÿè®¡å¡ç‰‡
   */
  @Builder
  StatCard(title: string, value: string | number, icon: string): void {
    Column() {
      Text(icon)
        .fontSize(32)
        .margin({ bottom: 8 })
      
      Text(title)
        .fontSize(14)
        .fontColor('#636E72')
        .margin({ bottom: 4 })
      
      Text(`${value}`)
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
        .fontColor('#FF6B6B')
    }
    .width('30%')
    .height(120)
    .padding(16)
    .backgroundColor('#FFFFFF')
    .borderRadius(16)
    .shadow({
      radius: 8,
      color: '#00000010',
      offsetY: 2
    })
  }

  /**
   * æ„å»ºæŸ±çŠ¶å›¾
   */
  @Builder
  BarChart(): void {
    Column() {
      Text('æœ€è¿‘7å¤©ä¸“æ³¨æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰')
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .fontColor('#2D3436')
        .margin({ bottom: 20 })
      
      Row() {
        ForEach(this.weekData, (item: StatisticsData, index: number) => {
          Column() {
            // æŸ±çŠ¶å›¾
            Column()
              .width(30)
              .height(item.pomodoros * 100 / this.getMaxPomodoros())
              .backgroundColor('#FF6B6B')
              .borderRadius(4)
              .margin({ bottom: 8 })
            
            // æ•°å€¼æ ‡ç­¾
            Text(`${item.pomodoros}`)
              .fontSize(12)
              .fontColor('#2D3436')
              .margin({ bottom: 4 })
            
            // æ—¥æœŸæ ‡ç­¾
            Text(this.formatDate(item.date))
              .fontSize(10)
              .fontColor('#636E72')
          }
          .width('14%')
          .height(200)
          .justifyContent(FlexAlign.End)
          .alignItems(HorizontalAlign.Center)
        })
      }
      .width('100%')
      .height(200)
      .justifyContent(FlexAlign.SpaceAround)
    }
    .width('100%')
    .padding(20)
    .backgroundColor('#FFFFFF')
    .borderRadius(20)
    .margin({ top: 16 })
  }

  /**
   * æ„å»ºæŠ˜çº¿å›¾ï¼ˆä½¿ç”¨Canvasæ¨¡æ‹Ÿï¼‰
   */
  @Builder
  LineChart(): void {
    Column() {
      Text('ä¸“æ³¨æ—¶é—´è¶‹åŠ¿')
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .fontColor('#2D3436')
        .margin({ bottom: 20 })
      
      // ä½¿ç”¨Rowå’ŒColumnæ¨¡æ‹ŸæŠ˜çº¿å›¾
      Stack() {
        // èƒŒæ™¯ç½‘æ ¼
        Column() {
          ForEach([0, 1, 2, 3, 4], (i: number) => {
            Divider()
              .color('#E0E0E0')
              .strokeWidth(1)
              .margin({ top: 40 })
          })
        }
        .width('100%')
        .height(180)
        
        // æ•°æ®ç‚¹è¿çº¿ï¼ˆä½¿ç”¨è§†è§‰å…ƒç´ æ¨¡æ‹Ÿï¼‰
        Row() {
          ForEach(this.weekData, (item: StatisticsData, index: number) => {
            Column() {
              // æ•°æ®ç‚¹
              Circle()
                .width(12)
                .height(12)
                .fill('#FF6B6B')
                .margin({ bottom: 4 })
              
              Text(`${item.focusTime}åˆ†é’Ÿ`)
                .fontSize(10)
                .fontColor('#636E72')
            }
            .width('14%')
            .height(180)
            .justifyContent(FlexAlign.End)
            .alignItems(HorizontalAlign.Center)
          })
        }
        .width('100%')
        .height(180)
      }
      .width('100%')
      .height(180)
    }
    .width('100%')
    .padding(20)
    .backgroundColor('#FFFFFF')
    .borderRadius(20)
    .margin({ top: 16 })
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Button('â†')
          .width(40)
          .height(40)
          .fontSize(20)
          .backgroundColor('#F7F7F7')
          .borderRadius(20)
          .margin({ right: 12 })
          .onClick(() => {
            router.back();
          })
        
        Text('æ•°æ®ç»Ÿè®¡')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor('#2D3436')
        
        Blank()
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .backgroundColor('#FFFFFF')
      
      Scroll() {
        Column() {
          // ç»Ÿè®¡å¡ç‰‡åŒºåŸŸ
          Row() {
          this.StatCard('æ€»ç•ªèŒ„æ•°', this.totalPomodoros, 'ğŸ…')
          this.StatCard('æ€»ä¸“æ³¨æ—¶é—´', this.formatFocusTimeDisplay(this.totalFocusSeconds), 'â±ï¸')
            this.StatCard('ä»»åŠ¡æ€»æ•°', this.totalTasks, 'ğŸ“‹')
          }
          .width('100%')
          .justifyContent(FlexAlign.SpaceAround)
          .margin({ top: 16 })
          
          // æŸ±çŠ¶å›¾
          this.BarChart()
          
          // æŠ˜çº¿å›¾
          this.LineChart()
          
          // è¯¦ç»†æ•°æ®åˆ—è¡¨
          Column() {
            Text('è¯¦ç»†æ•°æ®')
              .fontSize(18)
              .fontWeight(FontWeight.Medium)
              .fontColor('#2D3436')
              .margin({ bottom: 16 })
            
            ForEach(this.weekData, (item: StatisticsData) => {
              Row() {
                Column() {
                  Text(this.formatDate(item.date))
                    .fontSize(16)
                    .fontWeight(FontWeight.Medium)
                    .fontColor('#2D3436')
                  
                  Text(`${item.tasks}ä¸ªä»»åŠ¡`)
                    .fontSize(12)
                    .fontColor('#636E72')
                    .margin({ top: 4 })
                }
                .alignItems(HorizontalAlign.Start)
                
                Blank()
                
                Column() {
                  Text(`${item.pomodoros} åˆ†é’Ÿ`)
                    .fontSize(16)
                    .fontColor('#FF6B6B')
                    .fontWeight(FontWeight.Medium)
                  
                  Text(`${item.focusTime}åˆ†é’Ÿ`)
                    .fontSize(12)
                    .fontColor('#636E72')
                    .margin({ top: 4 })
                }
                .alignItems(HorizontalAlign.End)
              }
              .width('100%')
              .padding(16)
              .backgroundColor('#F7F7F7')
              .borderRadius(12)
              .margin({ bottom: 8 })
            })
          }
          .width('100%')
          .padding(20)
          .backgroundColor('#FFFFFF')
          .borderRadius(20)
          .margin({ top: 16, bottom: 32 })
        }
        .width('100%')
        .padding(16)
      }
      .layoutWeight(1)
      .scrollBar(BarState.Auto)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F7F7F7')
  }
}
